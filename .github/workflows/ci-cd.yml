name: CI/CD Pipeline

# Khi nào chạy workflow?
on:
  push:
    branches:
      - main # chạy khi push code lên nhánh main
  pull_request:
    branches:
      - main # chạy khi có pull request vào nhánh main

jobs:
  build-and-push:
    runs-on: ubuntu-latest # GitHub sẽ tạo 1 máy ảo Ubuntu để chạy

    steps:
      # 1. Lấy source code từ repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Cài đặt Docker Buildx (dùng để build image đa nền tảng)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Đăng nhập Docker Hub bằng secret đã tạo
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Build và Push image Docker lên Docker Hub
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: . # Thư mục chứa Dockerfile
          push: true # Đẩy image lên Docker Hub
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/ecommerce-demo:latest
          
      - name: Trigger Render deployment
        if: github.event_name == 'push'
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK }}
